<p align="center">
  <a href="#">
    <img width="400" src="https://github.com/3Tecnos-Development/mono/assets/5139981/ec6daa7c-9107-46ae-9389-1e20e93cca39">
  </a>
</p>
<h1 align="center" style="color:purple">X-School</h1>

<h1 align="center">Curso de Desenvolvimento Full Stack com Node.js, React Native e Monorepo NX (DDD e SOLID)</h1>

<h1 align="center">DDD (Domain-driven Design)</h1>

### Aula 05

#### Domain Event

Em DDD (Design de DomÃ­nio Dirigido), um "Domain Event" (Evento de DomÃ­nio) Ã© um conceito que descreve algo significativo que ocorreu no domÃ­nio do problema de um software. Ã‰ uma representaÃ§Ã£o abstrata de um evento que tem relevÃ¢ncia dentro do contexto do negÃ³cio que o software estÃ¡ modelando. Esses eventos capturam mudanÃ§as de estado ou transiÃ§Ãµes importantes que ocorrem nas entidades e agregados do domÃ­nio.

Os eventos de domÃ­nio sÃ£o uma parte crucial do DDD porque eles ajudam a tornar a comunicaÃ§Ã£o e a colaboraÃ§Ã£o entre diferentes componentes do sistema mais explÃ­citas e claras. Em vez de permitir que os componentes se comuniquem diretamente ou dependam uns dos outros, eles se comunicam por meio de eventos que sÃ£o capturados, gerados e consumidos por diferentes partes do sistema.

CaracterÃ­sticas:

1. RepresentaÃ§Ã£o de Acontecimentos
   > [!NOTE] <span style="color:purple"> Os eventos de domÃ­nio representam algo que ocorreu no domÃ­nio do problema, como um pedido ser feito, um pagamento ser efetuado, um item ser adicionado ao carrinho, etc.
2. Imutabilidade
   > [!NOTE] <span style="color:purple"> Uma vez que um evento de domÃ­nio Ã© criado, ele nÃ£o deve ser alterado. Isso garante que o histÃ³rico de eventos permaneÃ§a preciso e confiÃ¡vel.
3. Decoupling (Desacoplamento)
   > [!NOTE] <span style="color:purple"> Os eventos de domÃ­nio ajudam a evitar um acoplamento rÃ­gido entre componentes do sistema, permitindo que eles se comuniquem sem depender diretamente uns dos outros.
4. HistÃ³rico e Rastreabilidade
   > [!NOTE] <span style="color:purple"> Ao capturar eventos significativos, Ã© possÃ­vel construir um histÃ³rico de todas as aÃ§Ãµes que ocorreram no sistema. Isso Ã© Ãºtil para auditoria, anÃ¡lise e reconstruÃ§Ã£o de estados passados.
5. IntegraÃ§Ã£o
   > [!NOTE] <span style="color:purple"> Os eventos de domÃ­nio sÃ£o frequentemente usados em arquiteturas orientadas a eventos e sistemas distribuÃ­dos para permitir a integraÃ§Ã£o entre diferentes partes do sistema.

##### Vejamos alguns exemplos:

ðŸ’¡ Domain Event _licitacaoPublicadaEvent_

```typescript
import { DomainEvent } from "@3tecnos/arch/domain";
import compradorDomain from "esenvo/domain/comprador";

export type LicitacaoPublicadaPayload = {
  licitacao: compradorDomain.licitacao.Licitacao;
  unidadeGestora: compradorDomain.unidadeGestora.UnidadeGestora;
};

export class LicitacaoPublicadaEvent extends DomainEvent<LicitacaoPublicadaPayload> {}
```

ðŸ’¡ Handler _EnviarEmailDeLicitantePublicadaParaLicitantesHandler_

ðŸ’¡ API

```typescript
import { Config } from "@3tecnos/config";
import { EventHandler, Handler } from "@3tecnos/events";
import { SendEmailPort } from "@3tecnos/services";
import { dateToString, INITIAL_OPTIONS } from "@3tecnos/util";
import compradorDomain from "esenvo/domain/comprador";
import { EsenvoApplicationConfigOptions } from "../../../config-options";

@Handler({
  events: [compradorDomain.LicitacaoPublicadaEvent],
})
export class EnviarEmailDeLicitacaoPublicadaParaLicitantesHandler
  implements EventHandler<compradorDomain.LicitacaoPublicadaEvent>
{
  constructor(
    private readonly config: Config<EsenvoApplicationConfigOptions>,
    private readonly sendEmail: SendEmailPort
  ) {}

  async handle(event: compradorDomain.LicitacaoPublicadaEvent): Promise<void> {
    const { licitacao, unidadeGestora } = event.payload;
    const emails: Array<string> = [];
    const from = this.config.getRequiredString("APP_EMAIL");

    if (!from) throw new Error("NÃ£o foi possÃ­vel encontrar o e-mail de domÃ­nio da aplicaÃ§Ã£o");

    for (let index = 0; index < licitacao.atividades.length; index++) {
      const atividadeId = licitacao.atividades[index];
      if (!atividadeId) continue;

      const atividadesVinculadas = await this.dbContext.atividade.collection
        .withParentsIds(unidadeGestora.municipio.uf)
        .whereEqualTo("id", atividadeId.value)
        .findOne();

      if (atividadesVinculadas) {
        atividadesVinculadas.emails?.map((email) => emails.push(email));
      }
    }

    await this.sendEmail.send("esenvo", "enviarLicitacaoParaLicitante", {
      toAddresses: emails,
      from,
      payload: {
        title: "LicitaÃ§Ã£o",
        nomeDaUnidadeGestora: unidadeGestora.nome.value,
        descricao: licitacao.objeto.value,
        numeroDaLicitacao: licitacao.identificacao,
        dataDeAbertura: dateToString(licitacao.abertura.value, { ...INITIAL_OPTIONS }),
      },
    });
  }
}
```

ðŸ’¡ Domain Event _folhaPagaEvent_

```typescript
import { DomainEvent } from "@3tecnos/arch/domain";
import domain from "rh/domain";

export type FolhaPagaPayload = {
  servidor: domain.servidor.Servidor;
  lancamento: domain.lancamento.Lancamento;
  unidadeGestora: domain.unidadeGestora.UnidadeGestora;
};

export class FolhaPagaEvent extends DomainEvent<FolhaPagaPayload> {}
```

ðŸ’¡ Handler _EnviarEmailDeFolhaPagaParaOsServidoresHandler_

```typescript
import { Config } from "@3tecnos/config";
import { EventHandler, Handler } from "@3tecnos/events";
import { SendEmailPort } from "@3tecnos/services";
import { dateToString, INITIAL_OPTIONS } from "@3tecnos/util";
import domain from "rh/comprador";
import { RHApplicationConfigOptions } from "../../../config-options";

@Handler({
  events: [domain.FolhaPagaEvent],
})
export class EnviarEmailDeFolhaPagaParaOsServidoresHandler implements EventHandler<domain.FolhaPagaEvent> {
  constructor(
    private readonly config: Config<ERHApplicationConfigOptions>,
    private readonly sendEmail: SendEmailPort
  ) {}

  async handle(event: domain.FolhaPagaPayload): Promise<void> {
    const { servidor, lancamento, unidadeGestora } = event.payload;
    const email: servidor.email;
    const from = this.config.getRequiredString("APP_EMAIL");

    if (!from) throw new Error("NÃ£o foi possÃ­vel encontrar o e-mail de domÃ­nio da aplicaÃ§Ã£o");

    await this.sendEmail.send("rh", "enviarEmailDoContraChequeParaOServidor", {
      toAddresses: [email],
      from,
      payload: {
        title: "Contracheque",
        nomeDaUnidadeGestora: unidadeGestora.nome.value,
        descricao: lancamento.obterDescricao(),
        servidor,
        lancamento,
      },
    });
  }
}
```

ðŸ’¡ Handler _EnviarFolhaPagaParaATransparenciaHandler_

```typescript
import { Config } from "@3tecnos/config";
import { EventHandler, Handler } from "@3tecnos/events";
import { EnviaParaTransparenciaRHPort } from "@3tecnos/services";
import { dateToString, INITIAL_OPTIONS } from "@3tecnos/util";
import domain from "rh/comprador";
import { RHApplicationConfigOptions } from "../../../config-options";

@Handler({
  events: [domain.FolhaPagaEvent],
})
export class EnviarFolhaPagaParaATransparenciaHandler implements EventHandler<domain.FolhaPagaEvent> {
  constructor(
    private readonly config: Config<ERHApplicationConfigOptions>,
    private readonly enviaParaTransparenciaRH: EnviaParaTransparenciaRHPort
  ) {}

  async handle(event: domain.FolhaPagaPayload): Promise<void> {
    const { lancamento } = event.payload;

    await this.enviaParaTransparenciaRH.enviar("Folha", {
      payload: {
        lancamento,
      },
    });
  }
}
```
